# release package
name: Github Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

jobs:
  build-binaries:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      TARBALL_TARGETS: linux-x64,linux-arm64,darwin-x64,darwin-arm64,win32-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: us-west-2

      - uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: yarn

      - run: yarn

      - run: yarn build

      - name: Find packaged node version
        id: find_packaged_node_version
        working-directory: packages/cli
        run: |
          echo "NODE_VERSION=$(jq -r .oclif.update.node.version package.json)" >> "${GITHUB_OUTPUT}"

      - uses: actions/cache@v3
        id: cache-oclif-pack
        name: Setup cache for oclif pack
        with:
          path: packages/cli/tmp/cache
          key: preevy-oclif-pack-node-v${{ steps.find_packaged_node_version.outputs.NODE_VERSION }}

      - name: Pack tarballs
        working-directory: packages/cli
        run: yarn oclif pack tarballs --parallel --no-xz --targets $TARBALL_TARGETS

      - name: Upload tarballs
        working-directory: packages/cli
        run: yarn oclif upload tarballs --no-xz --targets $TARBALL_TARGETS

      - name: Rename tarballs to remove git sha
        if: startsWith(github.ref, 'refs/tags/')
        working-directory: packages/cli/dist
        run: |
          git_sha="$(git rev-parse --short HEAD)"
          for f in $(find . -maxdepth 1 -type f -name 'preevy-v*'); do
            new_name="$(echo ${f} | sed 's/-'"${git_sha}"'//')"
            echo "Renaming ${f} to ${new_name}"
            mv "${f}" "${new_name}"
          done

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          draft: ${{ !startsWith(github.ref, 'refs/tags/') }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          files: |
            packages/cli/dist/preevy-v*.tar.gz
